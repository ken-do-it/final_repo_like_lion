server {
    listen 80;
    client_max_body_size 10M; # 업로드 파일 크기 제한 설정

    # 1. 프론트엔드 (React)
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }

    # 2. Django (백엔드) 연결
    # http://localhost/api/ -> Django로 전달
    location /api/ {
        proxy_pass http://django:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 3. Django Admin 페이지 연결
    # http://localhost/admin/ -> Django로 전달
    location /admin/ {
        proxy_pass http://django:8000/admin/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    large_client_header_buffers 4 16k;

    # accounts (소셜 로그인 등) 연결
    location /accounts/ {
        proxy_pass http://django:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Django Static 파일 (CSS/JS) 처리
    location /static/ {
        proxy_pass http://django:8000/static/;
    }

    # Django Media 파일 (업로드된 파일) 처리
    location /media/ {
        proxy_pass http://django:8000/media/;
    }

    # 4. FastAPI (AI 서버) 연결
    # http://localhost/ai/ -> FastAPI로 전달
    location /ai/ {
        proxy_pass http://fastapi:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 5. 교통 API (Django) - 항공/기차/지하철
    # /api/v1/transport/ 요청은 Django로 전달
    location /api/v1/transport/ {
        proxy_pass http://django:8000/api/v1/transport/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 5.5. 예약 API (Django) - 항공권 예약
    # /api/v1/reservations/ 요청은 Django로 전달
    location /api/v1/reservations/ {
        proxy_pass http://django:8000/api/v1/reservations/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 5.6. 결제 API (Django) - 토스페이먼츠 결제
    # /api/v1/payments/ 요청은 Django로 전달
    location /api/v1/payments/ {
        proxy_pass http://django:8000/api/v1/payments/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 6. FastAPI Places (장소/숙소/로드뷰 통합) 연결
    # /api/v1/ 로 시작하는 나머지 요청을 fastapi_places 서버로 전달
    location /api/v1/ {
        # 끝에 '/'를 붙여서 /api/v1/ 부분을 제거하고 백엔드에 전달하게 합니다.
        # 예: /api/v1/accommodations/nearby -> http://fastapi_places:8002/accommodations/nearby
        proxy_pass http://fastapi_places:8002/; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 검색 서비스 (fastapi_app)
    # 브라우저의 /search 접속은 위쪽 'location /' (React)가 처리하게 두고,
    # API 요청만 이 블록에서 처리합니다.
    location /search-api/ {
        # /search-api/search 요청이 들어오면 -> /search 로 바꿔서 백엔드에 전달
        rewrite ^/search-api/(.*)$ /$1 break;
        
        proxy_pass http://fastapi:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}